<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TOTPgen</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    [v-cloak] {
      display: none;
    }

    html, body {
      height: 100%;
    }

    body > footer {
      position: sticky;
      top: 100vh;
    }

    .footer {
      padding: 2rem;
    }

    .is-round-button {
      border-radius: 50%;
      width: 3rem;
      height: 3rem;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media screen and (min-width: 1068px) {
      .container {
        max-width: 600px;
        width: 600px;
      }
    }

    /* Modal alert/confirm icon colors */
    .modal-card-title .fa-info-circle {
      color: #3273dc;
    }

    .modal-card-title .fa-check-circle {
      color: #48c774;
    }

    .modal-card-title .fa-exclamation-triangle {
      color: #ffdd57;
    }

    .modal-card-title .fa-exclamation-circle {
      color: #f14668;
    }

    .modal-card-title .fa-question-circle {
      color: #3273dc;
    }

    .modal-card-body {
      font-size: 1.1rem;
      line-height: 1.6;
    }
  </style>
  <script>navigator.serviceWorker.register("/js/service-worker.js")</script> 
  <link rel="icon" href="/img/icons/favicon.ico" type="image/x-icon">
  <link rel="manifest" href="/manifest.json" />
</head>
<body>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.4.1/otpauth.umd.min.js"></script>  
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script>  
  <script defer src="js/app.js"></script>

  <section id="app" class="section" v-cloak>

    <!-- Password modal -->
    <div class="modal" :class="{ 'is-active': showPasswordModal }">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head d-flex is-flex-direction-column is-align-items-center">
          <img src="img/totpgen-web.png" alt="TOTPgen Logo" class="is-block mx-auto" style="max-width: 100px;">
          <p class="modal-card-title">Enter encryption password</p>
          <p class="subtitle is-7 has-text-centered">if you set a password before, your keys are encrypted using that password. <br/>please enter that password to unlock your saved keys (the password will not be sent anywhere)</p>
        </header>
        <section class="modal-card-body">
          <div v-if="passwordError" class="notification is-danger">
            {{ passwordError }}
          </div>
          <div class="field">
            <label class="label">Password</label>
            <div class="control">
              <input 
                class="input" 
                type="password" 
                v-model="masterPassword" 
                @keyup.enter="unlockApp"
                placeholder="Enter your master password (can be empty)"
                autofocus>
            </div>
          </div>
          <p class="help has-text-centered">This password will be used to encrypt and decrypt your saved TOTP keys.</p>
          <p class="help has-text-danger has-text-centered">You can leave it empty if you prefer, but your data will not be encrypted.</p>
        </section>
        <footer class="modal-card-foot has-text-centered is-justify-content-center">
          <button class="button is-primary" @click="unlockApp"><i class="fa fa-unlock"></i> Unlock</button>
        </footer>
      </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" :class="{ 'is-active': showChangePasswordModal }">
      <div class="modal-background" @click="closeChangePasswordDialog"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Change Password</p>
          <button class="delete" aria-label="close" @click="closeChangePasswordDialog"></button>
        </header>
        <section class="modal-card-body">
          <div v-if="changePasswordError" class="notification is-danger">
            {{ changePasswordError }}
          </div>
          <div class="field">
            <label class="label">Current Password</label>
            <div class="control">
              <input 
                class="input" 
                type="password" 
                v-model="currentPassword" 
                placeholder="Enter your current password">
            </div>
            <p class="help">Leave empty if you don't have a password set</p>
          </div>
          <div class="field">
            <label class="label">New Password</label>
            <div class="control">
              <input 
                class="input" 
                type="password" 
                v-model="newPassword" 
                placeholder="Enter your new password">
            </div>
          </div>
          <div class="field">
            <label class="label">Confirm New Password</label>
            <div class="control">
              <input 
                class="input" 
                type="password" 
                v-model="confirmNewPassword" 
                @keyup.enter="changePassword"
                placeholder="Repeat the new password">
            </div>
          </div>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-primary" @click="changePassword">Change Password</button>
          <button class="button ml-1" @click="closeChangePasswordDialog">Cancel</button>
        </footer>
      </div>
    </div>

    <div class="container">
      <img src="img/totpgen-web.png" alt="TOTPgen Logo" class="is-block mx-auto mb-3" style="max-width: 150px;">
      <p class="has-text-centered mb-4">TOTPgen is a secure, browser-based TOTP token generator that ensures your data stays private and encrypted.</p>
      <div class="container is-flex is-align-items-center is-justify-content-center mb-4">
        <a class="button is-info is-round-button" title="Get back to home" href="/">
          <i class="fa fa-home"></i>
        </a>
        <div class="is-flex-grow-1"></div>
        <button class="button is-info ml-1 is-round-button" @click="showChangePasswordDialog" title="Change Password">
          <i class="fa fa-key"></i>
        </button>
        <button class="button is-info ml-1 is-round-button" @click="$refs.qrFileInput.click()" title="Import from QR Code">
          <i class="fa fa-qrcode"></i>
        </button>
        <button class="button is-info ml-1 is-round-button" @click="openCamera" title="Scan QR Code with Camera">
          <i class="fa fa-camera"></i>
        </button>
        <button class="button is-info ml-1 is-round-button" @click="showExportDialog" title="Export Keys">
          <i class="fa fa-cloud-arrow-down"></i>
        </button>
        <button class="button is-info ml-1 is-round-button" @click="$refs.importFileInput.click()" title="Import Keys">
          <i class="fa fa-cloud-arrow-up"></i>
        </button>
        <div class="is-flex-grow-1"></div>
        <button class="button is-info ml-1 is-round-button is-danger" @click="clearAllConfiguration" title="Clear all configuration and saved keys">
          <i class="fa fa-trash "></i>
        </button>
      </div>

      <!-- Saved Keys List (only visible if there are saved keys) -->
      <div class="field" v-if="savedKeys.length > 0">
        <label class="label is-uppercase">Saved Keys</label>
        <div class="columns is-multiline">
          <div class="column is-one-third" v-for="(key, index) in savedKeys" :key="index">
            <div class="notification">
              <a href="#" class="is-size-7" @click.prevent="loadKey(key)">{{ key.name }}</a>
              <button class="delete is-small" @click.prevent="deleteKey(index)"></button>
            </div>
          </div>
        </div>
      </div>

      <div class="content">
        <span class="has-text-grey is-size-7">Updating in {{ updatingIn }} seconds</span>
        <progress class="progress is-info is-small" v-bind:value="updatingIn" :max="period"></progress>
      </div>

      <div class="box is-flex is-justify-content-center is-align-items-center">
        <p class="title is-size-1 has-text-centered is-flex-grow-1 mr-1" id="token">{{ token }}</p>
        <a class="button is-text" id="clipboard-button" data-clipboard-target="#token" title="Copy token to clipboard">
          <i class="fa-regular fa-paste"></i>
        </a>
      </div>

      <div class="field">
        <label class="label is-uppercase">Key Name (for saving)</label>
        <div class="container is-flex is-align-items-center is-gap-2 flex-row">
          <div class="control is-flex-grow-1 mr-1">
            <input class="input" type="text" v-model="key_name" placeholder="A name to identify this key">
          </div>
          <button class="button is-primary" @click="saveCurrentKey"><i class="fa fa-plus"></i></button>
        </div>
      </div>

      <div class="field">
        <label class="label is-uppercase">Secret Key</label>
        <div class="control">
          <input class="input" type="text" v-model="secret_key" placeholder="The secret key">
        </div>
      </div>

      <!-- Hidden file input for QR image upload -->
      <input class="is-hidden" type="file" accept="image/*" @change="handleQRImageUpload" ref="qrFileInput">

      <!-- Hidden file input for importing keys -->
      <input class="is-hidden" type="file" accept=".json,application/json" @change="handleImportFile" ref="importFileInput">

      <!-- Modal for camera QR scanner -->
      <div class="modal" :class="{ 'is-active': showCameraModal }">
        <div class="modal-background" @click="closeCameraModal"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">Scan QR Code</p>
            <button class="delete" aria-label="close" @click="closeCameraModal"></button>
          </header>
          <section class="modal-card-body">
            <div v-if="cameraError" class="notification is-danger">
              {{ cameraError }}
            </div>
            <div class="has-text-centered">
              <video ref="cameraVideo" autoplay playsinline style="max-width: 100%; border: 2px solid #ddd; border-radius: 4px;"></video>
              <canvas ref="cameraCanvas" style="display: none;"></canvas>
            </div>
            <p class="help mt-3 has-text-centered">Position the QR code within the camera view</p>
          </section>
          <footer class="modal-card-foot">
            <button class="button" @click="closeCameraModal">Cancel</button>
          </footer>
        </div>
      </div>

      <div class="field">
        <label class="label is-uppercase"># of Digits for Token</label>
        <div class="control">
          <input class="input" type="text" v-model="digits" placeholder="The most common value is 6">
        </div>
      </div>

      <div class="field">
        <label class="label is-uppercase">Token Validity (in seconds)</label>
        <div class="control">
          <input class="input" type="text" v-model="period" placeholder="The most common value is 30">
        </div>
      </div>

      <!-- Export Modal -->
      <div class="modal" :class="{ 'is-active': showExportModal }">
        <div class="modal-background" @click="closeExportDialog"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">Export Keys</p>
            <button class="delete" aria-label="close" @click="closeExportDialog"></button>
          </header>
          <section class="modal-card-body">
            <div v-if="exportError" class="notification is-danger">
              {{ exportError }}
            </div>
            <div class="content">
              <p>Export all your saved keys to a JSON file. You can optionally protect the export with a password.</p>
            </div>
            <div class="field">
              <label class="label">Export Password (optional)</label>
              <div class="control">
                <input 
                  class="input" 
                  type="password" 
                  v-model="exportPassword" 
                  placeholder="Enter password to encrypt the export">
              </div>
              <p class="help">Leave empty to export without encryption</p>
              <p class="help is-danger" v-if="exportPassword === ''">
                <i class="fa fa-exclamation-triangle"></i> Warning: Without a password, your keys will be exported in plain text!
              </p>
            </div>
            <div class="field">
              <label class="label">Confirm Password</label>
              <div class="control">
                <input 
                  class="input" 
                  type="password" 
                  v-model="exportPasswordConfirm" 
                  @keyup.enter="exportKeys"
                  placeholder="Confirm the password">
              </div>
            </div>
          </section>
          <footer class="modal-card-foot">
            <button class="button is-primary" @click="exportKeys">
              <span class="icon"><i class="fa fa-cloud-arrow-down"></i></span>
              <span>Export</span>
            </button>
            <button class="button ml-1" @click="closeExportDialog">Cancel</button>
          </footer>
        </div>
      </div>

      <!-- Import Conflict Modal -->
      <div class="modal" :class="{ 'is-active': showImportConflictModal }">
        <div class="modal-background" @click="cancelImportConflict"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">
              <i class="fa fa-exclamation-triangle"></i> Duplicate Key Name
            </p>
            <button class="delete" aria-label="close" @click="cancelImportConflict"></button>
          </header>
          <section class="modal-card-body">
            <p>A key with the name <strong>"{{ importConflictKey.name }}"</strong> already exists.</p>
            <p class="mt-3">What would you like to do?</p>
          </section>
          <footer class="modal-card-foot is-justify-content-center">
            <button class="button is-warning" @click="overwriteImportKey">
              <span class="icon"><i class="fa fa-save"></i></span>
              <span>Overwrite</span>
            </button>
            <button class="button is-info ml-1" @click="renameImportKey">
              <span class="icon"><i class="fa fa-edit"></i></span>
              <span>Rename</span>
            </button>
            <button class="button ml-1" @click="skipImportKey">Skip</button>
          </footer>
        </div>
      </div>

      <!-- Import Password Modal -->
      <div class="modal" :class="{ 'is-active': showImportPasswordModal }">
        <div class="modal-background" @click="closeImportPasswordDialog"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">Import Password Required</p>
            <button class="delete" aria-label="close" @click="closeImportPasswordDialog"></button>
          </header>
          <section class="modal-card-body">
            <div v-if="importPasswordError" class="notification is-danger">
              {{ importPasswordError }}
            </div>
            <div class="content">
              <p>This export file is encrypted. Please enter the password used during export.</p>
              <div v-if="importFileInfo">
                <p class="is-size-7 has-text-grey">
                  <strong>Version:</strong> {{ importFileInfo.version }}<br>
                  <strong>Export Date:</strong> {{ new Date(importFileInfo.exportDate).toLocaleString() }}<br>
                  <strong>Number of Keys:</strong> {{ importFileInfo.keysCount }}
                </p>
              </div>
            </div>
            <div class="field">
              <label class="label">Password</label>
              <div class="control">
                <input 
                  class="input" 
                  type="password" 
                  v-model="importPassword" 
                  @keyup.enter="processImportWithPassword"
                  placeholder="Enter the export password"
                  autofocus>
              </div>
            </div>
          </section>
          <footer class="modal-card-foot">
            <button class="button is-primary" @click="processImportWithPassword">
              <span class="icon"><i class="fa fa-unlock"></i></span>
              <span>Decrypt and Import</span>
            </button>
            <button class="button ml-1" @click="closeImportPasswordDialog">Cancel</button>
          </footer>
        </div>
      </div>

      <!-- Alert Modal -->
      <div class="modal" :class="{ 'is-active': alertModal.show }">
        <div class="modal-background" @click="closeAlertModal"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">
              <i class="fa" :class="alertModal.icon"></i> {{ alertModal.title }}
            </p>
            <button class="delete" aria-label="close" @click="closeAlertModal"></button>
          </header>
          <section class="modal-card-body">
            <p>{{ alertModal.message }}</p>
          </section>
          <footer class="modal-card-foot is-justify-content-center">
            <button class="button is-primary" @click="closeAlertModal">OK</button>
          </footer>
        </div>
      </div>

      <!-- Confirm Modal -->
      <div class="modal" :class="{ 'is-active': confirmModal.show }">
        <div class="modal-background" @click="cancelConfirmModal"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">
              <i class="fa fa-question-circle"></i> {{ confirmModal.title }}
            </p>
            <button class="delete" aria-label="close" @click="cancelConfirmModal"></button>
          </header>
          <section class="modal-card-body">
            <p>{{ confirmModal.message }}</p>
          </section>
          <footer class="modal-card-foot is-justify-content-center">
            <button class="button is-danger" @click="acceptConfirmModal">{{ confirmModal.acceptText }}</button>
            <button class="button ml-1" @click="cancelConfirmModal">{{ confirmModal.cancelText }}</button>
          </footer>
        </div>
      </div>
  </section>

  <footer class="footer">
    <div class="container">
      <div class="content has-text-centered">
        Created by <a href="https://github.com/dealfonso">Carlos A.</a> Source on <a href="https://github.com/dealfonso/totpgen">Github</a>.
      </div>
    </div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/js/all.min.js" integrity="sha512-6BTOlkauINO65nLhXhthZMtepgJSghyimIalb+crKRPhvhmsCdnIuGcVbR5/aQY2A+260iC1OPy1oCdB6pSSwQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>
